# Visualise Static Memory Allocation

This document describes how to use the `visualise_static_memory_allocation.py` script to generate a Plotly Gantt chart that illustrates the lifetimes of tensors and their buffer usage.

## Overview

The script `scripts/visualise_static_memory_allocation.py` creates an interactive Gantt chart to visualize how memory is allocated for tensors over time. Each bar in the chart represents a tensor's lifetime, and its color indicates the specific buffer it is allocated to. This visualization is useful for understanding and debugging the static memory allocation of your model.

## How to Use

1. **Generate the Input Data:**

   The input for the script is a JSON object that is generated by the Zig build process. When you run the `zig build lib-gen` command, the static memory planning information is printed to `stderr`.

   You can use the following example to see a possible result (this is a plan that was generated for `beer`)

   ```json
   [{"name":"model_1/block_2_project_BN/FusedBatchNormV3;model_1/block_2_project/Conv2D1_quantized","size":4608,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":17,"end_borrow":18}},{"name":"Relu6__15_0_quantized","size":27648,"backing_buffer":{"id":3,"size":36864,"element_type":"u8","start_borrow":14,"end_borrow":15}},{"name":"Relu6__22_0_quantized","size":6912,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":22,"end_borrow":23}},{"name":"Relu6__10_0_quantized","size":110592,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":9,"end_borrow":10}},{"name":"model_1/block_1_project_BN/FusedBatchNormV3;model_1/block_2_project/Conv2D;model_1/block_1_project/Conv2D1_quantized","size":4608,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":12,"end_borrow":18}},{"name":"model_1/block_2_depthwise_relu/Relu6;model_1/block_2_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise/depthwise;model_1/block_2_depthwise/depthwise_quantized","size":27648,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":15,"end_borrow":16}},{"name":"model_1/block_3_project_BN/FusedBatchNormV3;model_1/block_5_project/Conv2D;model_1/block_3_project/Conv2D1","size":2304,"backing_buffer":{"id":0,"size":9216,"element_type":"f32","start_borrow":24,"end_borrow":30}},{"name":"model_1/block_4_add/add_quantized","size":2304,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":31,"end_borrow":32}},{"name":"Relu6__32_0_quantized","size":13824,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":35,"end_borrow":36}},{"name":"model_1/block_5_add/add_quantized","size":2304,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":39,"end_borrow":40}},{"name":"StatefulPartitionedCall_0","size":432,"backing_buffer":{"id":7,"size":2304,"element_type":"f32","start_borrow":49,"end_borrow":50}},{"name":"model_1/Conv1_relu/Relu6;model_1/bn_Conv1/FusedBatchNormV3;model_1/expanded_conv_depthwise_BN/FusedBatchNormV3;model_1/expanded_conv_depthwise/depthwise;model_1/block_5_project/Conv2D;model_1/Conv1/Conv2D__40_0","size":9216,"backing_buffer":{"id":0,"size":9216,"element_type":"f32","start_borrow":1,"end_borrow":2}},{"name":"model_1/block_5_depthwise_relu/Relu6;model_1/block_5_depthwise_BN/FusedBatchNormV3;model_1/block_5_depthwise/depthwise;model_1/block_6_expand/Conv2D_quantized","size":13824,"backing_buffer":{"id":2,"size":36864,"element_type":"u8","start_borrow":34,"end_borrow":35}},{"name":"model_1/block_6_expand_relu/Relu6;model_1/block_6_expand_BN/FusedBatchNormV3;model_1/block_5_depthwise_BN/FusedBatchNormV3;model_1/block_5_depthwise/depthwise;model_1/block_6_expand/Conv2D_quantized","size":13824,"backing_buffer":{"id":2,"size":36864,"element_type":"u8","start_borrow":40,"end_borrow":41}},{"name":"model_1/head/Relu;model_1/head/BiasAdd;model_1/head/Conv2D;head/bias","size":4608,"backing_buffer":{"id":0,"size":9216,"element_type":"f32","start_borrow":43,"end_borrow":44}},{"name":"model_1/block_3_depthwise_relu/Relu6;model_1/block_3_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise/depthwise_quantized","size":6912,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":21,"end_borrow":22}},{"name":"Relu6__12_0_quantized","size":27648,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":11,"end_borrow":12}},{"name":"Relu__37_0_quantized","size":4608,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":45,"end_borrow":46}},{"name":"model_1/Conv1_relu/Relu6;model_1/bn_Conv1/FusedBatchNormV3;model_1/expanded_conv_depthwise_BN/FusedBatchNormV3;model_1/expanded_conv_depthwise/depthwise;model_1/block_5_project/Conv2D;model_1/Conv1/Conv2D_quantized","size":36864,"backing_buffer":{"id":2,"size":36864,"element_type":"u8","start_borrow":3,"end_borrow":4}},{"name":"Relu6__5_0_quantized","size":36864,"backing_buffer":{"id":3,"size":36864,"element_type":"u8","start_borrow":4,"end_borrow":5}},{"name":"model_1/block_3_project_BN/FusedBatchNormV3;model_1/block_5_project/Conv2D;model_1/block_3_project/Conv2D1_quantized","size":2304,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":23,"end_borrow":24}},{"name":"model_1/block_1_expand_relu/Relu6;model_1/block_1_expand_BN/FusedBatchNormV3;model_1/block_3_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise/depthwise;model_1/block_1_expand/Conv2D_quantized","size":110592,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":8,"end_borrow":9}},{"name":"Relu6__30_0_quantized","size":13824,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":33,"end_borrow":34}},{"name":"model_1/block_4_depthwise_relu/Relu6;model_1/block_4_depthwise_BN/FusedBatchNormV3;model_1/block_5_depthwise_BN/FusedBatchNormV3;model_1/block_5_depthwise/depthwise;model_1/block_6_expand/Conv2D;model_1/block_4_depthwise/depthwise_quantized","size":13824,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":26,"end_borrow":27}},{"name":"Relu6__7_0_quantized","size":36864,"backing_buffer":{"id":3,"size":36864,"element_type":"u8","start_borrow":6,"end_borrow":7}},{"name":"Relu6__17_0_quantized","size":27648,"backing_buffer":{"id":3,"size":36864,"element_type":"u8","start_borrow":16,"end_borrow":17}},{"name":"model_1/block_5_project_BN/FusedBatchNormV3;model_1/block_5_project/Conv2D1","size":2304,"backing_buffer":{"id":0,"size":9216,"element_type":"f32","start_borrow":37,"end_borrow":38}},{"name":"model_1/logits/BiasAdd;model_1/logits/Conv2D;logits/bias1_quantized","size":432,"backing_buffer":{"id":1,"size":9216,"element_type":"u8","start_borrow":46,"end_borrow":47}},{"name":"model_1/block_2_expand_relu/Relu6;model_1/block_2_expand_BN/FusedBatchNormV3;model_1/block_3_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise/depthwise;model_1/block_2_expand/Conv2D_quantized","size":27648,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":13,"end_borrow":14}},{"name":"model_1/block_4_project_BN/FusedBatchNormV3;model_1/block_5_project/Conv2D;model_1/block_4_project/Conv2D1","size":2304,"backing_buffer":{"id":6,"size":2304,"element_type":"f32","start_borrow":29,"end_borrow":30}},{"name":"model_1/block_5_project_BN/FusedBatchNormV3;model_1/block_5_project/Conv2D1_quantized","size":2304,"backing_buffer":{"id":1,"size":9216,"element_type":"u8","start_borrow":36,"end_borrow":37}},{"name":"model_1/head/Relu;model_1/head/BiasAdd;model_1/head/Conv2D;head/bias_quantized","size":4608,"backing_buffer":{"id":1,"size":9216,"element_type":"u8","start_borrow":42,"end_borrow":43}},{"name":"model_1/logits/BiasAdd;model_1/logits/Conv2D;logits/bias1","size":432,"backing_buffer":{"id":7,"size":2304,"element_type":"f32","start_borrow":47,"end_borrow":48}},{"name":"StatefulPartitionedCall_0_raw_output___3_0","size":432,"backing_buffer":{"id":0,"size":9216,"element_type":"f32","start_borrow":48,"end_borrow":49}},{"name":"model_1/expanded_conv_depthwise_relu/Relu6;model_1/expanded_conv_depthwise_BN/FusedBatchNormV3;model_1/expanded_conv_depthwise/depthwise;model_1/block_5_project/Conv2D_quantized","size":36864,"backing_buffer":{"id":2,"size":36864,"element_type":"u8","start_borrow":5,"end_borrow":6}},{"name":"model_1/block_1_depthwise_relu/Relu6;model_1/block_1_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise/depthwise;model_1/block_1_depthwise/depthwise_quantized","size":27648,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":10,"end_borrow":11}},{"name":"model_1/block_5_add/add","size":2304,"backing_buffer":{"id":6,"size":2304,"element_type":"f32","start_borrow":38,"end_borrow":39}},{"name":"Relu6__35_0_quantized","size":13824,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":41,"end_borrow":42}},{"name":"model_1/expanded_conv_project_BN/FusedBatchNormV3;model_1/block_2_project/Conv2D;model_1/expanded_conv_project/Conv2D1_quantized","size":18432,"backing_buffer":{"id":2,"size":36864,"element_type":"u8","start_borrow":7,"end_borrow":8}},{"name":"Relu__37_0","size":4608,"backing_buffer":{"id":8,"size":4608,"element_type":"f32","start_borrow":44,"end_borrow":45}},{"name":"model_1/block_4_project_BN/FusedBatchNormV3;model_1/block_5_project/Conv2D;model_1/block_4_project/Conv2D1_quantized","size":2304,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":28,"end_borrow":29}},{"name":"model_1/block_2_add/add_quantized","size":4608,"backing_buffer":{"id":1,"size":9216,"element_type":"u8","start_borrow":18,"end_borrow":19}},{"name":"Relu6__27_0_quantized","size":13824,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":27,"end_borrow":28}},{"name":"model_1/block_4_expand_relu/Relu6;model_1/block_4_expand_BN/FusedBatchNormV3;model_1/block_5_depthwise_BN/FusedBatchNormV3;model_1/block_5_depthwise/depthwise;model_1/block_6_expand/Conv2D;model_1/block_4_expand/Conv2D_quantized","size":13824,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":24,"end_borrow":25}},{"name":"model_1/Conv1_relu/Relu6;model_1/bn_Conv1/FusedBatchNormV3;model_1/expanded_conv_depthwise_BN/FusedBatchNormV3;model_1/expanded_conv_depthwise/depthwise;model_1/block_5_project/Conv2D;model_1/Conv1/Conv2D__40_0_quantized","size":9216,"backing_buffer":{"id":1,"size":9216,"element_type":"u8","start_borrow":2,"end_borrow":3}},{"name":"model_1/block_3_expand_relu/Relu6;model_1/block_3_expand_BN/FusedBatchNormV3;model_1/block_3_depthwise_BN/FusedBatchNormV3;model_1/block_3_depthwise/depthwise;model_1/block_3_expand/Conv2D_quantized","size":27648,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":19,"end_borrow":20}},{"name":"Relu6__20_0_quantized","size":27648,"backing_buffer":{"id":4,"size":110592,"element_type":"u8","start_borrow":20,"end_borrow":21}},{"name":"Relu6__25_0_quantized","size":13824,"backing_buffer":{"id":5,"size":110592,"element_type":"u8","start_borrow":25,"end_borrow":26}},{"name":"model_1/block_4_add/add","size":2304,"backing_buffer":{"id":7,"size":2304,"element_type":"f32","start_borrow":30,"end_borrow":38}},{"name":"model_1/block_5_expand_relu/Relu6;model_1/block_5_expand_BN/FusedBatchNormV3;model_1/block_5_depthwise_BN/FusedBatchNormV3;model_1/block_5_depthwise/depthwise;model_1/block_6_expand/Conv2D;model_1/block_5_expand/Conv2D_quantized","size":13824,"backing_buffer":{"id":2,"size":36864,"element_type":"u8","start_borrow":32,"end_borrow":33}}]
   ```

2. **Run the Script:**

   Once you have a `memory_allocation.json` file, you can run the Python script to generate the Gantt chart. The script takes the JSON file as a command-line argument.

   First, make sure you have the required Python libraries installed:

   ```sh
   pip install pandas plotly
   ```

   Then, run the script:

   ```sh
   python scripts/visualise_static_memory_allocation.py memory_allocation.json
   ```

3. **View the Chart:**

   The script will open a new window or tab in your web browser displaying the interactive Gantt chart. You can hover over the bars to see more details about each tensor, including its size, buffer ID, and lifetime.

## Chart Interpretation

- **Y-axis:** Represents the different tensors in the model.
- **X-axis:** Represents the steps or time.
- **Bars:** Each bar shows the lifetime of a tensor, from when it is borrowed to when it is returned.
- **Colors:** The color of each bar indicates the buffer that the tensor is allocated to. Tensors with the same color share the same buffer.
- **Hover Information:** Hovering over a bar will display detailed information about the tensor, including its name, size, buffer ID, and the duration of its borrow.
